<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Christmas Friend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* (reuse the same styles as your earlier scratch.html) */
    body { min-height:100vh; font-family:'Georgia', serif; color:#fff; overflow:hidden; background:#0a0e27; }
    .background { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg,#1a0000 0%,#4a0000 50%,#1a0000 100%); animation:bgShift 10s ease-in-out infinite; }
    /* ... rest of CSS same as original ... */
  </style>
</head>
<body>
  <div class="background"></div>

  <div class="container">
    <div class="content-box">
      <h1>üéÅ Don't you want to see your Christmas Friend! üéÑ</h1>
      <div id="content"></div>
    </div>
  </div>

  <script>
    // Shared keys (must match admin)
    const USED_KEY_PREFIX = 'christmas_friend_used_';
    const ASSIGNMENTS_KEY = 'christmas_assignments';
    const STUDENTS_KEY = 'christmas_students';

    // Default fallback assignments and studentNames (kept for safety)
    let assignments = {
      's1': 'Devangana M Nair',
      's2': 'Snigdha p',
      's3': 'Navrag K',
      's4': 'Alan John',
      's5': 'Chantal Rachel Rebeiro',
      's6': 'Nitin K',
      's7': 'Nakshatra',
      's8': 'Kirthana B',
      's9': 'Melwyn Ezekiel Nelson',
      's10': 'Riya',
      's11': 'M Navanetha',
      's12': 'Jomin S George',
      's13': 'Ashwin Victor J',
      's14': 'MUHAMMED SAHEEN NV',
      's15': 'Calvin Richard V',
      's16': 'Gowtham',
      's17': 'Prof.BalaSubrahmani',
      's18': 'Supriya Agnes J',
      's19': 'Vijay Sherpa',
      's20': 'S Shuba Zion',
      's21': 'Kavya Shree KS',
      's22': 'Jinsha P',
      's23': 'Rasvitha R',
      's24': 'Benet Kalunkil Babu',
      's25': 'Nivedh',
      's26': 'Shijin Shaji',
      's27': 'Anisha Anand',
      's28': 'S. Nithya Shree',
      's29': 'K Khavya Shree',
      's30': 'Bharath',
      's31': 'Supriya',
      's32': 'Poornima R',
      's33': 'Ck Victor',
      's34': 'M Felix Francis',
      's35': 'Aron',
      's36': 'Sebastian',
      's37': 'Mounish',
      's38': 'Monica P',
      's39': 'Nayan',
      's40': 'Rebecca',
      's41': 'Kalakotla Jonathan',
      's42': 'Diaz',
      's43': 'Deeksha MB',
      's44': 'Cyrus',
      's45': 'Budda Samuel Alex',
      's46': 'Annette Jerry Pereira',
      's47': 'Tony Paul P',
      's48': 'Joshua',
      's49': 'Fathimath Rifa',
      's50': 'Justin Johnson',
      's51': 'Srethul',
      's52': 'Vaishnavi R',
      's53': 'Arbiya',
      's54': 'Dorjith',
      's55': 'Siddharth L',
      's56': 'Asfa Naaz',
      's57': 'Staines Joy',
      's58': 'Kevin Palakar',
      's59': 'George',
      's60': 'Ann Sital',
      's61': 'Goutham',
      's62': 'Sharon Godfrey'
    };

    // studentNames fallback (used for greeting)
    let studentNames = {
      's1': 'MUHAMMED SAHEEN NV',
      's2': 'Navrag K',
      's3': 'Kavya Shree KS',
      's4': 'Vijay Sherpa',
      's5': 'Rasvitha R',
      's6': 'Shijin Shaji',
      's7': 'Kevin Palakar',
      's8': 'Melwyn Ezekiel Nelson',
      's9': 'Alan John',
      's10': 'Jinsha P',
      's11': 'Ck Victor',
      's12': 'S. Nithya Shree',
      's13': 'Kalakotla Jonathan',
      's14': 'Staines Joy',
      's15': 'Monica P',
      's16': 'Tony Paul P',
      's17': 'Devangana M Nair',
      's18': 'Anisha Anand',
      's19': 'Kirthana B',
      's20': 'Snigdha P',
      's21': 'Asfa Naaz',
      's22': 'M Navanetha',
      's23': 'Justin Johnson',
      's24': 'Sharon Godfrey',
      's25': 'Nitin K',
      's26': 'Benet Kalunkil Babu',
      's27': 'Annette Jerry Pereira',
      's28': 'Deeksha MB',
      's29': 'Fathimath Rifa',
      's30': 'Budda Samuel Alex',
      's31': 'Calvin Richard V',
      's32': 'Siddharth L',
      's33': 'Ashwin Victor J',
      's34': 'Chantal Rachel Rebeiro',
      's35': 'Supriya Agnes J',
      's36': 'Vaishnavi R',
      's37': 'M Felix Francis',
      's38': 'K Khavya Shree',
      's39': 'Jomin S George',
      's40': 'Sebastian',
      's41': 'S Shuba Zion',
      's42': 'Mounish',
      's43': 'Poornima R',
      's44': 'Srethul',
      's45': 'Joshua',
      's46': 'Goutham',
      's47': 'Aron',
      's48': 'George',
      's49': 'Arbiya',
      's50': 'Riya',
      's51': 'Cyrus',
      's52': 'Dorjith',
      's53': 'Bharath',
      's54': 'Gowtham',
      's55': 'Supriya',
      's56': 'Nakshatra',
      's57': 'Nivedh',
      's58': 'Diaz',
      's59': 'Rebecca',
      's60': 'Nayan',
      's61': 'Ann Sital',
      's62': 'Prof.BalaSubrahmani'
    };

    // Try to override assignments and studentNames from localStorage (saved by admin)
    function loadFromStorage() {
      try {
        const a = localStorage.getItem(ASSIGNMENTS_KEY);
        if (a) {
          const parsed = JSON.parse(a);
          if (parsed && typeof parsed === 'object') assignments = parsed;
        }
      } catch (e) { console.warn('failed loading assignments from storage', e); }

      // load students array and make a mapping id->name
      try {
        const s = localStorage.getItem(STUDENTS_KEY);
        if (s) {
          const parsedStudents = JSON.parse(s);
          if (Array.isArray(parsedStudents)) {
            const mapping = {};
            parsedStudents.forEach(st => { mapping[st.id] = st.name; });
            studentNames = mapping;
          }
        }
      } catch (e) { console.warn('failed loading students from storage', e); }
    }

    function getStudentIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('student');
    }

    function hasUsed(id) {
      return localStorage.getItem(USED_KEY_PREFIX + id) === 'true';
    }

    function markUsed(id) {
      localStorage.setItem(USED_KEY_PREFIX + id, 'true');
      localStorage.setItem('christmas_friend_done', 'true');
      localStorage.setItem('christmas_friend_opened', id);
    }

    function showError(message) {
      const content = document.getElementById('content');
      content.innerHTML = '<div class="error" style="padding:20px;border-radius:12px;background:rgba(255,0,0,0.12);">'+message+'</div>';
    }

    function getRandomQuote() {
      const christmasQuotes = [
        "Christmas is not just a day, it's a feeling. May your heart be filled with warmth, joy, and the magic of giving this season!",
        "The best gift around the Christmas tree is the presence of family and friends wrapped in love. Cherish every moment!",
        "Christmas waves a magic wand over the world, and behold, everything is softer and more beautiful. Spread kindness wherever you go!",
        "May your Christmas sparkle with moments of love, laughter, and goodwill. Remember, the joy of brightening someone's day is the true spirit of Christmas!",
        "Christmas is doing a little something extra for someone. Your kindness and thoughtfulness make the world a better place!",
        "The magic of Christmas never ends, and its greatest gifts are family and friends. May this season bring you closer to those you love!"
      ];
      return christmasQuotes[Math.floor(Math.random() * christmasQuotes.length)];
    }

    // visual helpers (kept from your original file)
    function createSnowflakes() {
      for (let i = 0; i < 20; i++) {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.textContent = '‚ùÑ';
        snowflake.style.left = Math.random() * 100 + '%';
        snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
        snowflake.style.animationDelay = Math.random() * 5 + 's';
        snowflake.style.fontSize = (Math.random() * 1 + 0.5) + 'em';
        document.body.appendChild(snowflake);
      }
    }

    function createLights() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffd700', '#ff69b4'];
      for (let i = 0; i < 15; i++) {
        const light = document.createElement('div');
        light.className = 'light';
        light.style.left = Math.random() * 100 + '%';
        light.style.top = Math.random() * 100 + '%';
        light.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        light.style.animationDelay = Math.random() * 3 + 's';
        light.style.animationDuration = (Math.random() * 3 + 3) + 's';
        document.body.appendChild(light);
      }
    }

    function initRevealCard(friendName, studentId, studentName) {
      const content = document.getElementById('content');
      content.innerHTML = '';

      const greeting = document.createElement('div');
      greeting.className = 'greeting';
      greeting.textContent = `Hi ${studentName}!, Happy Christmas! üåü`;
      content.appendChild(greeting);

      const revealCard = document.createElement('div');
      revealCard.className = 'reveal-card';

      const cardInner = document.createElement('div');
      cardInner.className = 'card-inner';

      const cardFront = document.createElement('div');
      cardFront.className = 'card-front';
      cardFront.innerHTML = `
        <div class="card-front-content">
          <div class="gift-icon">üéÅ</div>
          <h2>Shazam!!üéÖ</h2>
        </div>
      `;

      const cardBack = document.createElement('div');
      cardBack.className = 'card-back';
      const sparklesDiv = document.createElement('div');
      sparklesDiv.className = 'sparkles';
      cardBack.appendChild(sparklesDiv);

      const friendDiv = document.createElement('div');
      friendDiv.className = 'friend-name';
      friendDiv.textContent = friendName;
      cardBack.appendChild(friendDiv);

      cardInner.appendChild(cardFront);
      cardInner.appendChild(cardBack);
      revealCard.appendChild(cardInner);
      content.appendChild(revealCard);

      const hint = document.createElement('p');
      hint.className = 'hint';
      hint.textContent = '‚ú® Click the gift to reveal your Christmas friend! ‚ú®';
      content.appendChild(hint);

      const quote = document.createElement('div');
      quote.className = 'quote';
      quote.textContent = `"${getRandomQuote()}"`;
      content.appendChild(quote);

      cardFront.addEventListener('click', () => {
        revealCard.classList.add('flipped');
        markUsed(studentId);
        // create some sparkles
        for (let i = 0; i < 20; i++) {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.style.left = Math.random() * 80 + 'px';
          sparkle.style.top = Math.random() * 80 + 'px';
          sparklesDiv.appendChild(sparkle);
          setTimeout(() => sparkle.remove(), 1600);
        }
        hint.style.display = 'none';
      });
    }

    (function main() {
      createSnowflakes();
      createLights();

      loadFromStorage();

      const studentId = getStudentIdFromUrl();
      if (!studentId) {
        showError('‚ùå Invalid link. Please use the main list to open your name.');
        return;
      }

      if (!assignments[studentId]) {
        showError('‚ùå No Christmas friend found for this link.');
        return;
      }

      // block if this device already opened ANY friend (and it's not this same link)
      const done = localStorage.getItem('christmas_friend_done') === 'true';
      const openedId = localStorage.getItem('christmas_friend_opened');

      if (done && openedId !== studentId) {
        showError('üéÑ You have already opened one Christmas friend on this device. You can only reveal one friend.');
        return;
      }

      // per-id check
      if (hasUsed(studentId)) {
        showError('üéÑ You have already opened this link on this device.');
        return;
      }

      const friendName = assignments[studentId];
      const studentName = studentNames[studentId] || 'Friend';
      initRevealCard(friendName, studentId, studentName);
    })();
  </script>
</body>
</html>
